---
title: "flu_merged"
output: github_document
---
Contains script for merging time point data

```{r}
# Load in the libraries
library(Seurat)
library(cowplot)
library(tidyverse)
```

```{r}
# Naive
naive_mat <- Matrix::readMM(file = "~/thesis/flu_GSE202002/flu_data/GSM6086518_Lung_mf_mo_naive_matrix.mtx.gz")
naive_genes <- read.table(file = "~/flu_data/GSM6086518_Lung_mf_mo_naive_features.tsv.gz")
naive_genes.names <- naive_genes[['V2']]
naive_barcodes <- read.table(file = "~/flu_data/GSM6086518_Lung_mf_mo_naive_barcodes.tsv.gz")
naive_barcodes.names <- naive_barcodes[['V1']]
colnames(naive_mat) <- naive_barcodes.names
rownames(naive_mat) <- naive_genes.names
naive_SO <- CreateSeuratObject(naive_mat, min.cells = 5)
naive_SO$orig.ident <- "d0"
naive_SO$timepoint <- "d0"
naive_length <- length(naive_SO@active.ident)
```

```{r d7}
# d7
# d7_mat <- Matrix::readMM(file = "~/flu_data/GSM6086519_Lung_mf_mo_flu_d7_matrix.mtx.gz")
# # Reading in the genes and formatting the resulting dataframe
# d7_genes <- read.table(file = "~/flu_data/GSM6086519_Lung_mf_mo_flu_d7_features.tsv.gz")
# d7_genes.names <- d7_genes[['V2']]
# d7_barcodes <- read.table(file = "~/flu_data/GSM6086519_Lung_mf_mo_flu_d7_barcodes.tsv.gz")
# d7_barcodes.names <- d7_barcodes[['V1']]
# colnames(d7_mat) <- d7_barcodes.names
# rownames(d7_mat) <- d7_genes.names
# d7_SO <- CreateSeuratObject(d7_mat, min.cells = 5)
# d7_SO$orig.ident <- "d7"
# d7_SO$timepoint <- "d7"
# d7_length <- length(d7_SO@active.ident)
```

```{r d14}
# d14
# d14_mat <- Matrix::readMM(file = "~/flu_data/GSM6086520_Lung_mf_mo_flu_d14_matrix.mtx.gz")
# # Reading in the genes and formatting the resulting dataframe
# d14_genes <- read.table(file = "~/flu_data/GSM6086520_Lung_mf_mo_flu_d14_features.tsv.gz")
# d14_genes.names <- d14_genes[['V2']]
# d14_barcodes <- read.table(file = "~/flu_data/GSM6086520_Lung_mf_mo_flu_d14_barcodes.tsv.gz")
# d14_barcodes.names <- d14_barcodes[['V1']]
# colnames(d14_mat) <- d14_barcodes.names
# rownames(d14_mat) <- d14_genes.names
# d14_SO <- CreateSeuratObject(d14_mat, min.cells = 5)
# d14_SO$orig.ident <- "d14"
# d14_SO$timepoint <- "d14"
# d14_length <- length(d14_SO@active.ident)
```

```{r day 30}
# d30
# d30_mat <- Matrix::readMM(file = "~/flu_data/GSM6086521_Lung_mf_mo_flu_d30_matrix.mtx.gz")
# # Reading in the genes and formatting the resulting dataframe
# d30_genes <- read.table(file = "~/flu_data/GSM6086521_Lung_mf_mo_flu_d30_features.tsv.gz")
# d30_genes.names <- d30_genes[['V2']]
# d30_barcodes <- read.table(file = "~/flu_data/GSM6086521_Lung_mf_mo_flu_d30_barcodes.tsv.gz")
# d30_barcodes.names <- d30_barcodes[['V1']]
# colnames(d30_mat) <- d30_barcodes.names
# rownames(d30_mat) <- d30_genes.names
# d30_SO <- CreateSeuratObject(d30_mat, min.cells = 5)
# d30_SO$orig.ident <- "d30"
# d30_SO$timepoint <- "d30"
# d30_length <- length(d30_SO@active.ident)
```

```{r}
# Make the "flu list" - a combined list of all the objects to merge
flu.list <- c(naive_SO, d7_SO, d14_SO, d30_SO)
# Iterate through each object in the list to pre-process it
for (i in 1:length(flu.list)) {
    flu.list[[i]] <- subset (flu.list[[i]], nFeature_RNA > 500)
    flu.list[[i]] <- NormalizeData(flu.list[[i]], verbose = TRUE)
    flu.list[[i]] <- FindVariableFeatures(flu.list[[i]], selection.method = "vst", 
        nfeatures = 2000, verbose = TRUE)
}
```

```{r}
# Making the anchor dataset
flu.anchors.all <- FindIntegrationAnchors(object.list = flu.list, dims = 1:30)

# Using the anchor dataset to create a final merged object
flu.integrated.all <- IntegrateData(anchorset = flu.anchors.all, dims = 1:30)

# Reordering the merged object so the timepoints are in chronological order
flu.integrated.all$timepoint<- factor(flu.integrated.all$timepoint, levels = c("d0", "d7", "d14", "d30"))
flu.integrated.all$orig.ident<- factor(flu.integrated.all$orig.ident, levels = c("d0", "d7", "d14", "d30"))
```

```{r}
# Run the integrated assay on the merged object for easier plotting
DefaultAssay(flu.integrated.all) <- "integrated"

# Run the standard workflow for visualization and clustering
flu.integrated.all <- ScaleData(flu.integrated.all, verbose = FALSE)
flu.integrated.all <- RunPCA(flu.integrated.all, npcs = 30, verbose = FALSE)
# t-SNE and Clustering
flu.integrated.all <- RunUMAP(flu.integrated.all, reduction = "pca", dims = 1:20)
flu.integrated.all <- FindNeighbors(flu.integrated.all, reduction = "pca", dims = 1:20)
flu.integrated.all <- FindClusters(flu.integrated.all, resolution = 0.5)
```

```{r}
# Visualization
p1 <- DimPlot(flu.integrated.all, reduction = "umap", group.by = "timepoint")
p2 <- DimPlot(flu.integrated.all, reduction = "umap", label = TRUE)
plot_grid(p1, p2)
```

```{r}
# Find markers for the clusters in the flu.integrated.all object
flu.all.markers <- FindAllMarkers(flu.integrated.all, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
```

```{r}
# Plot clusters to identify Pparg+, SiglecF+, and Epcam+ cells, which we'll label as real AMs
VlnPlot(flu.integrated.all, features = c("Pparg", "Siglecf", "Epcam"), pt.size = 0)

FeaturePlot(flu.integrated.all, features = c("Pparg", "Siglecf"), max.cutoff = 3, cols = c("grey", "red"), order = T)
```
Based on this, I called clusters 3, 7, 8, 9, 10 as AMs.


```{r}
# Relabel cell types with their identities
cluster.ids <- c("Mono_1", "IM_1", "Mono_2", "AM_1", "IM_2", "Mono_3", "trans_mac", "AM_2", "AM_3", "AM_4", "AM_5", "B", "IM_3", "T")
names(cluster.ids) <- levels(flu.integrated.all)
flu.integrated.all <- RenameIdents(flu.integrated.all, cluster.ids)
flu.integrated.all$celltype <- Idents(flu.integrated.all)
DimPlot(flu.integrated.all, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()
```

In labeling the rest of the clusters, I noticed that clusters 11 and 13 were small contaminants of T and B cells, respectively. Removing these clusters since they're not needed:

```{r}
Idents(flu.integrated.all) <- "celltype"
flu.integrated.all <- subset(flu.integrated.all, idents = c("Mono_1", "Mono_2", "Mono_3", "IM_1", "IM_2", "IM_3", "AM_1", "AM_2", "AM_3", "AM_4", "AM_5", "trans_mac"))
DimPlot(flu.integrated.all, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()
```

# Plot multiple MHC I, II genes at once

```{r add module score for MHC I, II to the integrated object}
# Using tutorial from https://github.com/satijalab/seurat/issues/3521
# MHC I
flu.integrated.all <- AddModuleScore(flu.integrated.all, features = list(MHC_I_list), name = "MHCI_genes", assay = "RNA")
# MHC II
flu.integrated.all <- AddModuleScore(flu.integrated.all, features = list(MHC_II_list), name = "MHCII_genes", assay = "RNA")
```

```{r create a column with cell type and timepoint}
flu.integrated.all$celltype <- Idents(flu.integrated.all)
flu.integrated.all$celltype.time <- paste(Idents(flu.integrated.all), flu.integrated.all$timepoint, sep = "_")
Idents(flu.integrated.all) <- "celltype.time"
View(flu.integrated.all@meta.data)
```

```{r Group by cell type and order by timepoint}
# Group by cell type and order by timepoint
flu.integrated.all$celltype.time<- factor(flu.integrated.all$celltype.time, levels = c("AM_1_d0", "AM_1_d7", "AM_1_d14", "AM_1_d30", "AM_2_d0", "AM_2_d7", "AM_2_d14", "AM_2_d30", "AM_3_d0", "AM_3_d7", "AM_3_d14", "AM_3_d30", "AM_4_d0", "AM_4_d7", "AM_4_d14", "AM_4_d30", "AM_5_d0", "AM_5_d7", "AM_5_d14", "AM_5_d30", "IM_1_d0", "IM_1_d7", "IM_1_d14", "IM_1_d30", "IM_2_d0", "IM_2_d7", "IM_2_d14", "IM_2_d30", "IM_3_d0", "IM_3_d7", "IM_3_d14", "IM_3_d30", "Mono_1_d0", "Mono_1_d7", "Mono_1_d14", "Mono_1_d30", "Mono_2_d0", "Mono_2_d7", "Mono_2_d14", "Mono_2_d30", "Mono_3_d0", "Mono_3_d7", "Mono_3_d14", "Mono_3_d30", "trans_mac_d0", "trans_mac_d7", "trans_mac_d14", "trans_mac_d30"))

# Group by timepoint and order by celltype
flu.integrated.all$celltype.time<- factor(flu.integrated.all$celltype.time, levels = c("AM_1_d0", "AM_2_d0", "AM_3_d0", "AM_4_d0", "AM_5_d0", "AM_1_d7", "AM_2_d7", "AM_3_d7", "AM_4_d7", "AM_5_d7", "AM_1_d14", "AM_2_d14", "AM_3_d14", "AM_4_d14", "AM_5_d14", "AM_1_d30", "AM_2_d30", "AM_3_d30", "AM_4_d30", "AM_5_d30", "IM_1_d0", "IM_2_d0", "IM_3_d0", "IM_1_d7", "IM_2_d7", "IM_3_d7", "IM_1_d14", "IM_2_d14", "IM_3_d14", "IM_1_d30", "IM_2_d30", "IM_3_d30", "Mono_1_d0", "Mono_2_d0", "Mono_3_d0", "Mono_1_d7", "Mono_2_d7", "Mono_3_d7", "Mono_1_d14", "Mono_2_d14", "Mono_3_d14", "Mono_1_d30", "Mono_2_d30", "Mono_3_d30", "trans_mac_d0", "trans_mac_d7", "trans_mac_d14", "trans_mac_d30"))

flu.integrated.all$celltype <- factor(flu.integrated.all$celltype, levels = c("AM_1", "AM_2", "AM_3", "AM_4", "AM_5", "IM_1", "IM_2", "IM_3", "Mono_1", "Mono_2", "Mono_3", "trans_mac"))
```

Now that cell types are labeled and grouped together, we can identify a SiglecF+ cell population and track this throughout the time course.

```{r}
FeaturePlot(flu.integrated.all, features = c("Siglecf", "Pparg", "Epcam"), max.cutoff = 3, cols = c("grey", "red"), order = T, split.by = "timepoint", label = TRUE)
VlnPlot(flu.integrated.all, features = c("Siglecf", "Pparg", "Epcam"), pt.size = 0, split.by = "timepoint", group.by = "celltype")
```